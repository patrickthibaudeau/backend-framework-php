<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold">{{#str}}roles_title, theme_default{{/str}}</h1>
  <a href="{{home_link}}" class="text-blue-600 hover:underline">{{#str}}back_admin_home, theme_default{{/str}}</a>
</div>
{{#flashes}}
  <div class="mb-4 p-3 rounded {{css_class}}">{{msg}}</div>
{{/flashes}}
<div class="grid md:grid-cols-2 gap-6">
  {{^editing}}
  <div class="md:col-span-1 bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-3">{{#str}}create_role_heading, theme_default{{/str}}</h2>
    <form method="post" class="space-y-3">
      <input type="hidden" name="action" value="create_role" />
      <input type="hidden" name="csrf_token" value="{{csrf_token}}" />
      <div>
        <label class="block text-sm">{{#str}}field_shortname, theme_default{{/str}}</label>
        <input name="shortname" class="w-full border px-2 py-1 rounded" required />
      </div>
      <div>
        <label class="block text-sm">{{#str}}field_name, theme_default{{/str}}</label>
        <input name="name" class="w-full border px-2 py-1 rounded" required />
      </div>
      <div>
        <label class="block text-sm">{{#str}}field_sortorder, theme_default{{/str}}</label>
        <input name="sortorder" type="number" class="w-full border px-2 py-1 rounded" value="100" />
      </div>
      <div>
        <label class="block text-sm">{{#str}}field_description, theme_default{{/str}}</label>
        <textarea name="description" class="w-full border px-2 py-1 rounded" rows="3"></textarea>
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded">{{#str}}create_button, theme_default{{/str}}</button>
    </form>
  </div>
  {{/editing}}
  <div class="md:col-span-1 bg-white p-4 rounded shadow max-h-[70vh] overflow-auto">
    <h2 class="font-semibold mb-3">{{#str}}existing_roles_heading, theme_default{{/str}}</h2>
    <table class="w-full text-sm">
      <thead><tr class="text-left"><th class="py-1">{{#str}}field_name, theme_default{{/str}}</th><th>{{#str}}field_short, theme_default{{/str}}</th><th>{{#str}}field_order, theme_default{{/str}}</th><th></th></tr></thead>
      <tbody>
      {{#roles}}
        <tr class="border-t">
          <td class="py-1 font-medium">{{name}}</td>
          <td>{{shortname}}</td>
          <td>{{sortorder}}</td>
          <td class="space-x-2 whitespace-nowrap">
            <a class="text-blue-600 hover:underline" href="roles.php?edit={{id}}">{{#str}}edit_link, theme_default{{/str}}</a>
            <a class="text-indigo-600 hover:underline" href="role_assign.php?role={{id}}">{{#str}}assign_role_users_link, theme_default{{/str}}</a>
          </td>
        </tr>
      {{/roles}}
      </tbody>
    </table>
  </div>
  {{#editing}}
  <div class="md:col-span-1 bg-white p-4 rounded shadow overflow-auto max-h-[80vh]">
    <div class="flex items-start justify-between mb-3">
      <h2 class="font-semibold">{{#str}}edit_role_heading, theme_default{{/str}} {{role.name}}</h2>
      <a href="roles.php" class="text-xs px-2 py-1 rounded border border-slate-300 hover:bg-slate-100 text-slate-600">{{#str}}close_button, theme_default{{/str}}</a>
    </div>
    <form method="post" class="mb-6 space-y-3">
      <input type="hidden" name="action" value="update_role_meta" />
      <input type="hidden" name="csrf_token" value="{{csrf_token}}" />
      <div>
        <label class="block text-xs font-medium">{{#str}}field_name, theme_default{{/str}}</label>
        <input name="name" value="{{role.name}}" class="w-full border rounded px-2 py-1 text-sm" required />
      </div>
      <div>
        <label class="block text-xs font-medium">{{#str}}field_description, theme_default{{/str}}</label>
        <textarea name="description" rows="2" class="w-full border rounded px-2 py-1 text-sm">{{role.description}}</textarea>
      </div>
      <div>
        <label class="block text-xs font-medium">{{#str}}field_sortorder, theme_default{{/str}}</label>
        <input type="number" name="sortorder" value="{{role.sortorder}}" class="w-full border rounded px-2 py-1 text-sm" />
      </div>
      <button class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">{{#str}}update_role_info_button, theme_default{{/str}}</button>
    </form>
    <form method="post">
      <input type="hidden" name="action" value="update_role_caps" />
      <input type="hidden" name="csrf_token" value="{{csrf_token}}" />
      <div class="mb-4">
        <h3 class="font-semibold mb-2">{{#str}}templates_heading, theme_default{{/str}}</h3>
        {{#templates}}
          <label class="flex items-center space-x-2 text-sm mb-1">
            <input type="checkbox" name="templates[]" value="{{id}}" {{#checked}}checked{{/checked}} />
            <span>{{shortname}}</span>
          </label>
        {{/templates}}
        {{^templates}}<p class="text-xs text-gray-500">{{#str}}no_templates_defined, theme_default{{/str}}</p>{{/templates}}
      </div>
      <div class="mb-4">
        <h3 class="font-semibold mb-2">{{#str}}capabilities_heading, theme_default{{/str}}</h3>
        <table class="w-full text-xs">
          <thead><tr><th class="text-left">{{#str}}capability_label, theme_default{{/str}}</th><th>{{#str}}type_label, theme_default{{/str}}</th><th>{{#str}}permission_label, theme_default{{/str}}</th></tr></thead>
          <tbody>
          {{#capabilities}}
            <tr class="border-t">
              <td class="py-1 pr-2">{{name}}</td>
              <td class="py-1 pr-2 text-gray-500">{{type}}</td>
              <td class="py-1">
                <select name="{{field}}" class="border rounded px-1 py-0.5">
                  {{#options}}
                    <option value="{{value}}" {{#selected}}selected{{/selected}}>{{value}}</option>
                  {{/options}}
                </select>
              </td>
            </tr>
          {{/capabilities}}
          </tbody>
        </table>
      </div>
      <button class="bg-green-600 text-white px-4 py-2 rounded">{{#str}}save_changes_button, theme_default{{/str}}</button>
    </form>
    <div class="mt-6">
      <h3 class="font-semibold mb-2">{{#str}}assigned_users_heading, theme_default{{/str}}</h3>
      <ul class="text-sm mb-3 space-y-1" id="assignedUsersList">
        {{#user_assignments}}
          <li class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded">
            <span>{{username}}</span>
            <form method="post" onsubmit="return confirm('{{#str}}confirm_unassign_user, theme_default{{/str}}');">
              <input type="hidden" name="action" value="unassign_user" />
              <input type="hidden" name="userid" value="{{id}}" />
              <input type="hidden" name="csrf_token" value="{{../csrf_token}}" />
              <button class="text-red-600 text-xs">{{#str}}remove_button, theme_default{{/str}}</button>
            </form>
          </li>
        {{/user_assignments}}
        {{^user_assignments}}<li class="text-xs text-gray-500">{{#str}}no_users_assigned, theme_default{{/str}}</li>{{/user_assignments}}
      </ul>
      <div class="mt-4 border-t pt-4">
        <label class="block text-xs font-medium mb-1">{{#str}}user_search_placeholder, theme_default{{/str}}</label>
        <input id="userSearchInput" type="text" class="w-full border rounded px-2 py-1 text-sm" placeholder="{{#str}}user_search_placeholder, theme_default{{/str}}" autocomplete="off" />
        <div id="userSearchStatus" class="mt-1 text-xs text-gray-500 hidden"></div>
        <form id="batchAssignForm" method="post" class="mt-3 hidden flex-col gap-2">
          <input type="hidden" name="action" value="assign_users_batch" />
          <input type="hidden" name="csrf_token" value="{{csrf_token}}" />
          <div id="userResults" class="max-h-48 overflow-auto border rounded p-2 space-y-1 bg-white"></div>
          <div class="flex justify-end">
            <button type="submit" class="bg-green-600 text-white text-xs px-3 py-1 rounded disabled:opacity-40" disabled>{{#str}}add_selected_button, theme_default{{/str}}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {{/editing}}
</div>
<script>
// Multi-select user search & batch assignment
(function(){
  const input = document.getElementById('userSearchInput');
  if(!input) return; // only on editing panel
  const resultsBox = document.getElementById('userResults');
  const form = document.getElementById('batchAssignForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const statusEl = document.getElementById('userSearchStatus');
  let debounceTimer = null; let lastQuery='';
  function setStatus(msg, show=true){ if(!statusEl) return; statusEl.textContent=msg||''; statusEl.classList.toggle('hidden',!show || !msg); }
  function updateSubmitState(){ const any = resultsBox.querySelectorAll('input[type="checkbox"][name="userids[]"]:checked').length>0; submitBtn.disabled = !any; }
  resultsBox.addEventListener('change', updateSubmitState);
  function renderUsers(list){
    resultsBox.innerHTML='';
    if(!list.length){ resultsBox.innerHTML='<div class="text-xs text-gray-500">'+(statusEl.dataset.noMatch||'No users')+'</div>'; return; }
    list.forEach(u=>{
      const label=document.createElement('label');
      label.className='flex items-start gap-2 text-xs border rounded px-2 py-1 hover:bg-gray-50';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.name='userids[]'; cb.value=u.id; cb.className='mt-0.5';
      const meta=[]; if(u.fullname) meta.push(u.fullname); meta.push('@'+u.username); if(u.email) meta.push(u.email); if(u.idnumber) meta.push('#'+u.idnumber);
      const span=document.createElement('span'); span.textContent=meta.join(' · ');
      label.appendChild(cb); label.appendChild(span); resultsBox.appendChild(label);
    });
    updateSubmitState();
  }
  async function search(q){
    setStatus('Searching…'); form.classList.remove('hidden');
    try {
      const url = 'roles.php?edit={{role_id}}&user_search=1&q='+encodeURIComponent(q);
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      renderUsers(data);
      setStatus(data.length?'' : (statusEl.dataset.noMatch || ''));
    } catch(e){ setStatus('Error searching'); }
  }
  input.addEventListener('input', function(){
    const q=this.value.trim();
    if(q.length < 2){ lastQuery=''; resultsBox.innerHTML=''; form.classList.add('hidden'); setStatus(''); return; }
    if(q===lastQuery) return; lastQuery=q;
    clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>search(q), 300);
  });
})();
</script>
