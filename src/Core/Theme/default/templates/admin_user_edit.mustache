<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold">{{#str}}edit_user_title, theme_default{{/str}}</h1>
  <a href="{{return_url}}" class="text-blue-600 hover:underline">{{#str}}back_admin_home, theme_default{{/str}}</a>
</div>
{{#flashes}}
  <div class="mb-4 p-3 rounded {{css_class}} text-sm">{{msg}}</div>
{{/flashes}}
<div class="bg-white p-6 rounded shadow max-w-2xl">
  <h2 class="font-semibold text-lg mb-4">
    {{#create_mode}}{{#str}}create_user_heading, theme_default{{/str}}{{/create_mode}}
    {{^create_mode}}{{#str}}edit_user_heading, theme_default{{/str}} <span class="text-slate-600">{{user.username}}</span>{{/create_mode}}
  </h2>

  {{#user.is_deleted}}
    <div class="mb-4 p-3 rounded bg-red-50 border border-red-200 text-red-700 text-sm">{{#str}}user_deleted_notice, theme_default{{/str}}</div>
  {{/user.is_deleted}}
  {{#user.is_admin_primary}}
    <div class="mb-4 p-3 rounded bg-amber-50 border border-amber-200 text-amber-800 text-sm">{{#str}}user_primary_admin_protected, theme_default{{/str}}</div>
  {{/user.is_admin_primary}}

  <form method="post" class="space-y-5">
    <input type="hidden" name="action" value="save_user" />
    <input type="hidden" name="id" value="{{user.id}}" />
    <input type="hidden" name="return" value="{{return_url}}" />
    <input type="hidden" name="csrf_token" value="{{csrf_token}}" />

    <div class="grid md:grid-cols-2 gap-4">
      {{#create_mode}}
      <div class="md:col-span-1">
        <label for="username" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}username_label, theme_default{{/str}}</label>
        <input id="username" name="username" value="{{user.username}}" required pattern="[A-Za-z0-9._-]{3,}" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      {{/create_mode}}
      {{^create_mode}}
      <div>
        <label class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}username_label, theme_default{{/str}}</label>
        <input value="{{user.username}}" disabled class="w-full bg-slate-100 border border-slate-300 rounded px-3 py-2 text-sm" />
      </div>
      {{/create_mode}}
      <div>
        <label for="email" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}user_email_label, theme_default{{/str}}</label>
        <input id="email" name="email" value="{{user.email}}" type="email" required class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="firstname" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}field_firstname, theme_default{{/str}}</label>
        <input id="firstname" name="firstname" value="{{user.firstname}}" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="lastname" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}field_lastname, theme_default{{/str}}</label>
        <input id="lastname" name="lastname" value="{{user.lastname}}" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="idnumber" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}field_idnumber, theme_default{{/str}}</label>
        <input id="idnumber" name="idnumber" value="{{user.idnumber}}" maxlength="255" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label for="status" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}user_status_label, theme_default{{/str}}</label>
        <select id="status" name="status" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          {{#status_options}}
            <option value="{{value}}" {{#selected}}selected{{/selected}}>{{#str}}{{label_key}}, theme_default{{/str}}</option>
          {{/status_options}}
        </select>
      </div>
      <div>
        <label for="auth" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}user_auth_label, theme_default{{/str}}</label>
        <select id="auth" name="auth" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          {{#auth_options}}
            <option value="{{value}}" {{#selected}}selected{{/selected}}>{{#str}}{{label_key}}, theme_default{{/str}}</option>
          {{/auth_options}}
        </select>
      </div>
      {{#create_mode}}
      <div id="passwordFieldWrapper" class="md:col-span-2">
        <label for="password" class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}field_password, theme_default{{/str}}</label>
        <input id="password" name="password" type="password" minlength="6" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
        <p class="mt-1 text-xs text-slate-500">{{#str}}password_help_min_length, theme_default{{/str}}</p>
      </div>
      {{/create_mode}}
    </div>

    <div class="flex items-center gap-3 pt-2">
      <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-5 py-2 rounded shadow" type="submit">{{#str}}save_user_button, theme_default{{/str}}</button>
      <a href="{{return_url}}" class="text-sm px-4 py-2 rounded border border-slate-300 hover:bg-slate-50 text-slate-700 inline-flex items-center">{{#str}}cancel_button, theme_default{{/str}}</a>
    </div>
  </form>

  {{^create_mode}}
  <div class="mt-10 bg-white p-6 rounded shadow border border-slate-100">
    <h3 class="font-semibold mb-4 text-lg flex items-center gap-2">{{#str}}user_roles_assigned_heading, theme_default{{/str}}</h3>
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h4 class="text-sm font-medium mb-2">{{#str}}user_roles_assigned_heading, theme_default{{/str}}</h4>
        <ul class="space-y-2 text-sm">
          {{#has_assigned_roles}}
            {{#assigned_roles}}
            <li class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded border border-gray-200">
              <span class="font-medium">{{name}} <span class="text-xs text-gray-500">({{shortname}})</span></span>
              <form method="post" onsubmit="return confirm('Remove role?');" class="ml-3">
                <input type="hidden" name="action" value="remove_role" />
                <input type="hidden" name="roleid" value="{{id}}" />
                <input type="hidden" name="csrf_token" value="{{../csrf_token}}" />
                <button class="text-red-600 text-xs hover:underline" type="submit">{{#str}}remove_button, theme_default{{/str}}</button>
              </form>
            </li>
            {{/assigned_roles}}
          {{/has_assigned_roles}}
          {{^has_assigned_roles}}
            <li class="text-xs text-gray-500">{{#str}}no_roles_assigned, theme_default{{/str}}</li>
          {{/has_assigned_roles}}
        </ul>
      </div>
      <div>
        <h4 class="text-sm font-medium mb-2">{{#str}}user_roles_add_label, theme_default{{/str}}</h4>
        {{#has_available_roles}}
        <form method="post" class="flex items-end gap-3">
          <input type="hidden" name="action" value="assign_role" />
          <input type="hidden" name="csrf_token" value="{{csrf_token}}" />
          <div class="flex-1">
            <label class="block text-xs font-semibold mb-1 tracking-wide uppercase text-slate-500">{{#str}}user_roles_add_label, theme_default{{/str}}</label>
            <select name="roleid" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              {{#available_roles}}
                <option value="{{id}}">{{name}} ({{shortname}})</option>
              {{/available_roles}}
            </select>
          </div>
          <button class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-4 py-2 rounded" type="submit">{{#str}}assign_role_button, theme_default{{/str}}</button>
        </form>
        {{/has_available_roles}}
        {{^has_available_roles}}
          <p class="text-xs text-gray-500">{{#str}}no_roles_available, theme_default{{/str}}</p>
        {{/has_available_roles}}
      </div>
    </div>
  </div>
  {{/create_mode}}
</div>
<script>
  (function(){
    var createMode = {{#create_mode}}true{{/create_mode}}{{^create_mode}}false{{/create_mode}};
    if(!createMode) return;
    const authSelect = document.getElementById('auth');
    const pwWrapper = document.getElementById('passwordFieldWrapper');
    const pwInput = document.getElementById('password');
    function togglePw(){
      if(authSelect.value === 'manual'){ pwWrapper.style.display='block'; pwInput.required = true; }
      else { pwWrapper.style.display='none'; pwInput.required = false; pwInput.value=''; }
    }
    authSelect.addEventListener('change', togglePw);
    togglePw();
  })();
</script>
